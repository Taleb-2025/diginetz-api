<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TSL Flow Visualizer</title>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
body { font-family: system-ui; margin:16px; }
button { padding:8px 12px; border-radius:8px; cursor:pointer; }
#chart { width:100%; height:420px; margin-top:20px; }
.kpis { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
.kpi { border:1px solid #eee; padding:8px 12px; border-radius:8px; }
pre { background:#111; color:#eee; padding:10px; border-radius:8px; max-height:240px; overflow:auto;}
</style>
</head>

<body>

<h2>TSL Flow Visualizer</h2>

<input id="historyUrl" style="width:400px"
value="https://diginetz-api-production.up.railway.app/api/flow/analysis"/>

<button onclick="refresh()">Refresh</button>

<div class="kpis" id="kpis"></div>

<div id="chart"></div>

<h3>Last Event (raw)</h3>
<pre id="lastRaw">{}</pre>

<script>

const PHASE_Y = {
  BUILDING: 0,
  PEAK: 1,
  DISINTEGRATION: 2
};

const PHASE_LABELS = ["BUILDING", "PEAK", "DISINTEGRATION"];

let chart = echarts.init(document.getElementById("chart"));

function safeGet(obj, path) {
  return path.split('.').reduce((o,k)=>o?.[k], obj);
}

function levelFromResult(r) {
  const sts = safeGet(r,"sts.level");
  const ae = safeGet(r,"ae.type");

  if (ae === "ABSENT_EXECUTION") return "CRITICAL";
  if (sts === "TENSION") return "TENSION";
  return "STABLE";
}

function colorFor(level){
  if(level==="CRITICAL") return "#d81b60";
  if(level==="TENSION") return "#ff9800";
  return "#2e7d32";
}

function buildKPIs(history){
  let stable=0,tension=0,critical=0;

  history.forEach(r=>{
    const lvl = levelFromResult(r);
    if(lvl==="STABLE") stable++;
    if(lvl==="TENSION") tension++;
    if(lvl==="CRITICAL") critical++;
  });

  return [
    {label:"Total",value:history.length},
    {label:"Stable",value:stable},
    {label:"Tension",value:tension},
    {label:"Critical",value:critical}
  ];
}

function renderKPIs(kpis){
  const el=document.getElementById("kpis");
  el.innerHTML="";
  kpis.forEach(k=>{
    const div=document.createElement("div");
    div.className="kpi";
    div.innerHTML=`<b>${k.label}</b><br/>${k.value}`;
    el.appendChild(div);
  });
}

function renderChart(history){

  const points = history.map((r,i)=>{
    const phase = safeGet(r,"effect.phase");
    const y = PHASE_Y[phase];
    if(y===undefined) return null;

    const lvl = levelFromResult(r);

    return {
      value:[i,y],
      itemStyle:{ color: colorFor(lvl)},
      symbolSize: lvl==="CRITICAL"?14:8,
      payload:r
    };
  }).filter(Boolean);

  chart.setOption({
    grid:{left:60,right:20,top:20,bottom:60},
    tooltip:{
      formatter:(p)=>{
        const r=p.data.payload;
        return `
Index: ${p.data.value[0]}<br/>
Symbol: ${r.effect?.symbol}<br/>
Extension: ${r.effect?.extension}<br/>
Phase: ${r.effect?.phase}<br/>
Retro: ${r.delta?.retro_status||"-"}
`;
      }
    },
    xAxis:{ type:"value", name:"Index"},
    yAxis:{ type:"category", data:PHASE_LABELS },
    series:[{
      type:"scatter",
      data:points
    }]
  });
}

async function refresh(){
  const url=document.getElementById("historyUrl").value;
  try{
    const res=await fetch(url);
    const data=await res.json();

    const history = Array.isArray(data.history)
      ? data.history
      : Array.isArray(data.analysis)
      ? data.analysis
      : [];

    renderKPIs(buildKPIs(history));
    renderChart(history);

    document.getElementById("lastRaw").textContent =
      JSON.stringify(history.at(-1)||{},null,2);

  }catch(e){
    console.error(e);
  }
}

refresh();

</script>
</body>
</html>
